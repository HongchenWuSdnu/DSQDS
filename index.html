<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DSQDS Â· å…¨ç”Ÿå‘½å‘¨æœŸè‡ªç„¶èµ„æºå¤šç»´å®‰å…¨é‡åŒ–ä¸åŠ¨æ€åˆ†çº§ä½“ç³»</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#f5f7fb; --panel:#fff; --line:#e9edf3; --text:#0f172a; --muted:#64748b;
  --radius:16px; --shadow:0 10px 24px rgba(16,24,40,.08);
  --grad1:#4a6cf7; --grad2:#8b5cf6; --primary:#5b7cff; --green:#16a34a; --danger:#ef4444; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif}
.app{display:flex;min-height:100vh}

/* ä¾§æ  */
.side{width:260px;background:linear-gradient(180deg,var(--grad1),var(--grad2));color:#e9edff;padding:18px 14px 22px;position:sticky;top:0;height:100vh}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.brand .logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,#34d399,#4f46e5)}
.brand b{font-size:18px}
.sub{color:#dbe3ff;font-size:12px;line-height:1.4;margin:8px 2px 18px}
.nav a{display:flex;align-items:center;gap:10px;color:#f1f5ff;text-decoration:none;padding:10px 12px;border-radius:12px;margin:2px 0;cursor:pointer}
.nav a:hover{background:rgba(255,255,255,.12)}
.nav a.active{background:rgba(255,255,255,.24)}
.ico{width:10px;height:10px;border-radius:50%;background:#c7d2fe}

/* ä¸»åŒºåŸŸ */
.main{flex:1;padding:20px 24px 28px;overflow:auto}
.header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.header h1{margin:0;font-size:26px}
.actions{margin-left:auto;display:flex;gap:10px}
.btn{border:1px solid #cfd8e3;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff;border-color:transparent}
.btn.danger{background:#fff;color:#ef4444;border-color:#fecaca}
.btn:disabled{opacity:.5;cursor:not-allowed}

.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:12px 0 8px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.card h4{margin:0 0 8px 0;font-size:13px;color:#475569}
.kpi{font-size:30px;font-weight:800;color:#5b6ee5}
.kpi.green{color:var(--green)}
.subkpi{color:#8a99af;font-size:12px}

.grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;margin-top:10px}
.grid2{display:grid;grid-template-columns:1.1fr 1fr;gap:16px;margin-top:16px}
.panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.ph{padding:10px 14px;color:#fff;background:linear-gradient(90deg,#6474ff,#8b5cf6);display:flex;align-items:center;gap:8px}
.ph .dot{width:10px;height:10px;border-radius:50%;background:#c7d2fe}
.pb{padding:14px 16px}

.legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;color:#64748b;font-size:12px}
.legend span i{display:inline-block;width:10px;height:10px;margin-right:6px;border-radius:50%}

.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f2f4fb;color:#334155;white-space:nowrap}
.badge.green{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
.badge.orange{border-color:#fed7aa;background:#fff7ed;color:#9a3412}
.badge.blue{border-color:#bfdbfe;background:#eff6ff;color:#1d4ed8}
.badge.red{border-color:#fecaca;background:#fff1f2;color:#b91c1c}
.badge.gray{color:#475569}

.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th{padding:10px 12px;color:#6b7280;font-size:12px;text-align:left}
.table td{background:#fff;border:1px solid var(--line);border-left:none;border-right:none;padding:12px;vertical-align:middle}
.table tr{box-shadow:var(--shadow)}
.table td:first-child{border-left:1px solid var(--line);border-top-left-radius:12px;border-bottom-left-radius:12px}
.table td:last-child{border-right:1px solid var(--line);border-top-right-radius:12px;border-bottom-right-radius:12px}
.progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
.progress .bar{height:100%;background:linear-gradient(90deg,#5b7cff,#7c9dff)}
.right{text-align:right}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}

/* å¼¹çª— */
.mask{position:fixed;inset:0;background:rgba(15,23,42,.38);display:none;align-items:center;justify-content:center;z-index:50}
.dialog{width:640px;max-width:92vw;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.dialog .hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
.dialog .bd{padding:14px 16px}
.form{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:center}
.form label{color:#475569}
.form input,.form select,.form textarea{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
.form textarea{min-height:96px;resize:vertical}

/* äº‹ä»¶åˆ—è¡¨ */
.events{max-height:360px;overflow:auto;padding:8px 12px}
.evt{padding:12px 0;border-bottom:1px dashed #e5eaf2}
.evt:last-child{border-bottom:none}
.time{color:#94a3b8;font-size:12px;margin-bottom:6px}
.evt b{display:block;margin-bottom:2px}
.evt p{margin:0;color:#475569;font-size:13px}

.toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .25s;z-index:80}
.toast.show{opacity:1;transform:translateY(0)}

/* å“åº”å¼ */
@media (max-width:1200px){ .grid,.grid2{grid-template-columns:1fr} .cards{grid-template-columns:repeat(2,1fr)} .side{width:220px} }
@media (max-width:860px){ .side{display:none} .cards{grid-template-columns:1fr} .form{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
  <!-- ä¾§æ  -->
  <aside class="side">
    <div class="brand"><div class="logo"></div><b>DSQDS</b></div>
    <div class="sub">å…¨ç”Ÿå‘½å‘¨æœŸè‡ªç„¶èµ„æºå¤šç»´å®‰å…¨é‡åŒ–<br>ä¸åŠ¨æ€åˆ†çº§ä½“ç³»</div>
    <nav class="nav">
      <a class="active" data-route="dashboard"><span class="ico"></span> ä»ªè¡¨æ¿</a>
      <a data-route="objects"><span class="ico"></span> æ•°æ®å¯¹è±¡ç®¡ç†</a>
      <a data-route="threats"><span class="ico"></span> å¨èƒæ¸…å•</a>
      <a data-route="weights"><span class="ico"></span> æƒé‡é…ç½®</a>
      <a data-route="rules"><span class="ico"></span> å®‰å…¨è§„åˆ™</a>
      <a data-route="events"><span class="ico"></span> å®‰å…¨äº‹ä»¶</a>
      <a data-route="batch"><span class="ico"></span> æ‰¹é‡è¯„ä¼°</a>
    </nav>
  </aside>

  <!-- ä¸»ä½“ -->
  <main class="main">
    <!-- ä»ªè¡¨æ¿ -->
    <section id="view-dashboard" class="view">
      <div class="header"><span style="font-size:22px">ğŸ›¡</span><h1>ç³»ç»Ÿä»ªè¡¨æ¿</h1>
        <div class="actions"><button class="btn" id="btn-refresh">ğŸ”„ åˆ·æ–°</button></div>
      </div>
      <section class="cards">
        <div class="card"><h4>æ•°æ®å¯¹è±¡æ€»æ•°</h4><div class="kpi" id="kpi-obj">0</div></div>
        <div class="card"><h4>å¨èƒæ€»æ•°</h4><div class="kpi" id="kpi-threats">0</div></div>
        <div class="card"><h4>æ´»è·ƒè§„åˆ™</h4><div class="kpi" id="kpi-rules">0</div></div>
        <div class="card"><h4>ç³»ç»ŸçŠ¶æ€</h4><div class="kpi green">æ­£å¸¸</div><div class="subkpi">æ‰€æœ‰æœåŠ¡å¥åº·</div></div>
      </section>
      <section class="grid">
        <div class="panel">
          <div class="ph"><span class="dot"></span> å®‰å…¨ç­‰çº§åˆ†å¸ƒ</div>
          <div class="pb">
            <canvas id="chart-donut" height="300"></canvas>
            <div class="legend">
              <span><i style="background:#ef4444"></i>ä¸€èˆ¬æ•°æ®</span>
              <span><i style="background:#f59e0b"></i>å…¬å¼€æ•°æ®</span>
              <span><i style="background:#22c55e"></i>æ ¸å¿ƒæ•°æ®</span>
              <span><i style="background:#2563eb"></i>é‡è¦æ•°æ®</span>
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="ph"><span class="dot"></span> ç”Ÿå‘½å‘¨æœŸé˜¶æ®µåˆ†å¸ƒ</div>
          <div class="pb"><canvas id="chart-phase" height="260"></canvas></div>
        </div>
      </section>
      <section class="grid2">
        <div class="panel">
          <div class="ph"><span class="dot"></span> å¨èƒç»Ÿè®¡</div>
          <div class="pb"><canvas id="chart-mix" height="280"></canvas></div>
        </div>
        <div class="panel">
          <div class="ph"><span class="dot"></span> æœ€è¿‘å®‰å…¨äº‹ä»¶</div>
          <div class="events" id="event-list"></div>
        </div>
      </section>
    </section>

    <!-- æ•°æ®å¯¹è±¡ç®¡ç† -->
    <section id="view-objects" class="view" style="display:none">
      <div class="header"><span style="font-size:22px">ğŸ—„ï¸</span><h1>æ•°æ®å¯¹è±¡ç®¡ç†</h1>
        <div class="actions"><button class="btn primary" id="btn-add-obj">ï¼‹ æ·»åŠ æ•°æ®å¯¹è±¡</button></div>
      </div>
      <div class="panel">
        <div class="pb">
          <table class="table" id="obj-table"></table>
        </div>
      </div>
    </section>

    <!-- å¨èƒæ¸…å• -->
    <section id="view-threats" class="view" style="display:none">
      <div class="header"><span style="font-size:22px">âš ï¸</span><h1>å¨èƒæ¸…å•ç®¡ç†</h1>
        <div class="actions">
          <select id="threat-filter" class="btn">
            <option value="å…¨éƒ¨é˜¶æ®µ">å…¨éƒ¨é˜¶æ®µ</option>
            <option>é‡‡é›†</option><option>ä¼ è¾“</option><option>å…±äº«</option><option>å­˜å‚¨</option><option>åº”ç”¨</option>
          </select>
          <button class="btn primary" id="btn-add-threat">ï¼‹ æ·»åŠ å¨èƒ</button>
        </div>
      </div>
      <div class="panel">
        <div class="pb" id="threat-list"></div>
      </div>
    </section>

    <!-- æƒé‡é…ç½® -->
    <section id="view-weights" class="view" style="display:none">
      <div class="header"><span style="font-size:22px">âš™ï¸</span><h1>æƒé‡é…ç½®</h1>
        <div class="actions"><button class="btn primary" id="btn-save-weights">ğŸ’¾ ä¿å­˜é…ç½®</button></div>
      </div>
      <div class="panel">
        <div class="ph"><span class="dot"></span> å¤šç»´å®‰å…¨å±æ€§æƒé‡è®¾ç½®ï¼ˆæ€»å’Œ=1.0ï¼‰</div>
        <div class="pb">
          <div id="weights-form"></div>
        </div>
      </div>
    </section>

    <!-- å®‰å…¨è§„åˆ™ -->
    <section id="view-rules" class="view" style="display:none">
      <div class="header"><span style="font-size:22px">ğŸ“Œ</span><h1>å®‰å…¨è§„åˆ™ç®¡ç†</h1>
        <div class="actions"><button class="btn primary" id="btn-add-rule">ï¼‹ æ·»åŠ è§„åˆ™</button></div>
      </div>
      <div id="rules-container"></div>
    </section>

    <!-- å®‰å…¨äº‹ä»¶ -->
    <section id="view-events" class="view" style="display:none">
      <div class="header"><span style="font-size:22px">ğŸ”„</span><h1>å®‰å…¨äº‹ä»¶æ—¥å¿—</h1></div>
      <div class="panel">
        <div class="pb">
          <table class="table" id="events-table"></table>
        </div>
      </div>
    </section>

    <!-- æ‰¹é‡è¯„ä¼° -->
    <section id="view-batch" class="view" style="display:none">
      <div class="header"><span style="font-size:22px">ğŸ§ª</span><h1>æ‰¹é‡å®‰å…¨è¯„ä¼°</h1></div>
      <div class="panel">
        <div class="ph"><span class="dot"></span> æ‰¹é‡ä¸Šä¼ æ•°æ®å¯¹è±¡è¿›è¡Œå®‰å…¨è¯„ä¼°</div>
        <div class="pb">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div>
              <div class="badge blue">ç¤ºä¾‹æ•°æ®æ ¼å¼</div>
              <textarea class="mono" id="batch-sample">[
  {
    "name": "åœ°ç†æ•°æ®A",
    "spatial_scale": 0.8,
    "position_accuracy": 0.6,
    "content_sensitivity": 0.9,
    "data_flow": 0.4,
    "historical_risk": 0.3
  }
]</textarea>
            </div>
            <div>
              <div class="badge blue">æ‰¹é‡è¯„ä¼°è¾“å…¥</div>
              <textarea class="mono" id="batch-input">[
  {
    "name": "åœ°ç†æ•°æ®A",
    "spatial_scale": 0.8,
    "position_accuracy": 0.6,
    "content_sensitivity": 0.9,
    "data_flow": 0.4,
    "historical_risk": 0.3
  }
]</textarea>
              <div style="margin-top:8px;text-align:right"><button class="btn primary" id="btn-batch">â–¶ å¼€å§‹è¯„ä¼°</button></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:14px">
        <div class="ph"><span class="dot"></span> æ‰¹é‡è¯„ä¼°ç»“æœ</div>
        <div class="pb">
          <table class="table" id="batch-table"></table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- é€šç”¨å¼¹çª— -->
<div class="mask" id="mask">
  <div class="dialog">
    <div class="hd" id="dlg-title">æ–°å»º</div>
    <div class="bd">
      <form id="dlg-form" class="form"></form>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button class="btn" type="button" id="dlg-cancel">å–æ¶ˆ</button>
        <button class="btn primary" type="submit" id="dlg-ok">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast">å·²ä¿å­˜</div>

<script>
/* -------------------- å·¥å…· -------------------- */
const toast = (t)=>{const el=document.getElementById('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500);};
const nowStr = ()=>new Date().toLocaleString('zh-CN',{hour12:false});
const levelOf = (score)=> score>=0.8?'æ ¸å¿ƒæ•°æ®':score>=0.6?'é‡è¦æ•°æ®':score>=0.3?'ä¸€èˆ¬æ•°æ®':'å…¬å¼€æ•°æ®';
const levelBadge = (lv)=> lv==='æ ¸å¿ƒæ•°æ®'?'green': lv==='é‡è¦æ•°æ®'?'orange': lv==='ä¸€èˆ¬æ•°æ®'?'red':'blue';
const phaseBadge = (p)=>({é‡‡é›†:'blue',ä¼ è¾“:'purple',å…±äº«:'orange',å­˜å‚¨:'green',åº”ç”¨:'gray'}[p]||'gray');
/* -------------------- ä¼ªè·¯ç”± -------------------- */
const routes=['dashboard','objects','threats','weights','rules','events','batch'];
function showView(name){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  document.getElementById('view-'+name).style.display='';
  document.querySelectorAll('.nav a').forEach(a=>a.classList.toggle('active',a.dataset.route===name));
  location.hash = name;
  if(name==='dashboard'&&!window._chartsInited){initCharts();window._chartsInited=true;}
  if(name==='dashboard') syncKpis();
}
document.querySelectorAll('.nav a').forEach(a=>a.onclick=()=>showView(a.dataset.route));
window.addEventListener('load', ()=>showView(routes.includes(location.hash.slice(1))?location.hash.slice(1):'dashboard'));

/* -------------------- çŠ¶æ€æ•°æ® -------------------- */
let weights={ S:.2, P:.2, C:.3, F:.15, H:.15 }; // æ€»å’Œ=1
let objects=[
  {id:1,name:'å›½å®¶é‡ç‚¹å·¥ç¨‹é¥æ„Ÿå½±åƒæ•°æ®',type:'é¥æ„Ÿå½±åƒ',phase:'å­˜å‚¨',attrs:{S:.7,P:.6,C:.9,F:.2,H:.3},updated:nowStr()},
  {id:2,name:'çœçº§åŸºç¡€åœ°ç†ä¿¡æ¯æ•°æ®',type:'åŸºç¡€åœ°ç†ä¿¡æ¯',phase:'å…±äº«',attrs:{S:.5,P:.6,C:.6,F:.5,H:.2},updated:nowStr()},
  {id:3,name:'å¸‚çº§ä¸“é¢˜é¥æ„Ÿæ•°æ®',type:'ä¸“é¢˜åœ°å›¾',phase:'åº”ç”¨',attrs:{S:.3,P:.5,C:.4,F:.6,H:.2},updated:nowStr()},
  {id:4,name:'å¿çº§å…¬å¼€åœ°å›¾æ•°æ®',type:'å…¬å¼€å¤„ç†æ•°æ®',phase:'åº”ç”¨',attrs:{S:.2,P:.3,C:.2,F:.4,H:.1},updated:nowStr()},
  {id:5,name:'ä¼ æ„Ÿå™¨å®æ—¶ç›‘æµ‹æ•°æ®',type:'ä¼ æ„Ÿå™¨æ•°æ®',phase:'ä¼ è¾“',attrs:{S:.6,P:.7,C:.8,F:.7,H:.3},updated:nowStr()},
];
const scoreOf = (o)=> +(o.attrs.S*weights.S + o.attrs.P*weights.P + o.attrs.C*weights.C + o.attrs.F*weights.F + o.attrs.H*weights.H).toFixed(2);
let threats=[
  {id:'T001',name:'éæ³•è®¾å¤‡æ¥å…¥',stage:'é‡‡é›†',desc:'æœªæˆæƒè®¾å¤‡æ¥å…¥æ•°æ®é‡‡é›†ç½‘ç»œ',impact:'æ•°æ®å®Œæ•´æ€§',risk:.7},
  {id:'T002',name:'é‡‡é›†è¿‡ç¨‹æ•°æ®è¢«æ¶æ„ä¿®æ”¹',stage:'é‡‡é›†',desc:'å½±å“æ•°æ®çœŸå®æ€§',impact:'æ•°æ®çœŸå®æ€§',risk:.8},
  {id:'T003',name:'ä¼ æ„Ÿå™¨æ•…éšœ/ç¯å¢ƒå¹²æ‰°',stage:'é‡‡é›†',desc:'å¯¼è‡´æ•°æ®è¯¯å·®',impact:'æ•°æ®çœŸå®æ€§',risk:.5},
  {id:'T004',name:'æ•°æ®åŒ…æˆªè·',stage:'ä¼ è¾“',desc:'ä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®åŒ…è¢«æˆªè·',impact:'æ•°æ®ä¿å¯†æ€§',risk:.6},
  {id:'T005',name:'é“¾è·¯ç›‘å¬',stage:'ä¼ è¾“',desc:'ç½‘ç»œé“¾è·¯è¢«æ¶æ„ç›‘å¬',impact:'æ•°æ®æœºå¯†æ€§',risk:.7},
  {id:'T006',name:'æ³¨å…¥æ”»å‡»',stage:'ä¼ è¾“',desc:'å¼‚å¸¸è®¿é—®å¯¼è‡´æ±¡æŸ“',impact:'å®Œæ•´æ€§',risk:.8},
];
let rules=[
  {id:'R001',cat:'å±æ€§è§„åˆ™',enable:true,prio:1,cond:{type:'score_threshold',threshold:0.8},act:{type:'encryption',level:'high',description:'é«˜çº§åŠ å¯†å­˜å‚¨'}},
  {id:'R002',cat:'å±æ€§è§„åˆ™',enable:true,prio:2,cond:{type:'security_level',level:'æ ¸å¿ƒæ•°æ®'},act:{type:'access_control',level:'strict',description:'ä¸¥æ ¼è®¿é—®æ§åˆ¶'}},
  {id:'R003',cat:'è¡Œä¸ºè§„åˆ™',enable:true,prio:1,cond:{type:'lifecycle_stage',stage:'å…±äº«'},act:{type:'audit',level:'full',description:'å…¨ç¨‹å®¡è®¡è®°å½•'}},
  {id:'R004',cat:'äº‹ä»¶è§¦å‘è§„åˆ™',enable:true,prio:1,cond:{type:'anomaly',kind:'abnormal_access'},act:{type:'mfa',level:'require',description:'å¯ç”¨å¤šå› å­è®¤è¯'}}
];
let events=[
  {id:'E002',trigger:'å¤–éƒ¨å®‰å…¨é¢„è­¦è§¦å‘',strategy:'é™åˆ¶æ•°æ®å…±äº«ã€å¯åŠ¨å®¡è®¡è®°å½•',result:'æœ‰æ•ˆæ§åˆ¶æ•°æ®æµé€šï¼Œè®°å½•å®Œæ•´æ“ä½œæ—¥å¿—',time:nowStr()},
  {id:'E003',trigger:'æ£€æµ‹åˆ°æ•°æ®å¤šæ¬¡æµè½¬æœªè„±æ•',strategy:'å¼ºåˆ¶è„±æ•å¤„ç†ï¼Œé™åˆ¶å…±äº«æ¬¡æ•°',result:'è„±æ•ç­–ç•¥ç”Ÿæ•ˆï¼Œå…±äº«æ¬¡æ•°é™åˆ¶ç”Ÿæ•ˆ',time:nowStr()},
  {id:'E004',trigger:'å­˜å‚¨ä»‹è´¨å¼‚å¸¸æ£€æµ‹',strategy:'æ•°æ®åªè¯»é”å®šï¼Œè§¦å‘å®‰å…¨å®¡è®¡',result:'åŠæ—¶å‘ç°å¹¶ä¿®å¤å­˜å‚¨é—®é¢˜ï¼Œæ•°æ®å®‰å…¨å¾—åˆ°ä¿éšœ',time:nowStr()},
  {id:'E005',trigger:'æƒé™é…ç½®é”™è¯¯æ£€æµ‹',strategy:'é‡æ–°é…ç½®æœ€å°è®¿é—®æƒé™ï¼Œé€šçŸ¥ç®¡ç†å‘˜',result:'æƒé™é…ç½®å·²ä¿®æ­£ï¼Œç³»ç»Ÿå®‰å…¨æ€§å¾—åˆ°æå‡',time:nowStr()},
  {id:'E001',trigger:'æ£€æµ‹åˆ°å¼‚å¸¸è®¿é—®è¡Œä¸º',strategy:'å¯åŠ¨å¤šå› å­è®¤è¯ï¼Œæå‡åˆ†çº§',result:'æˆåŠŸé˜»æ­¢æœªæˆæƒè®¿é—®ï¼Œé‡è¦æ•°æ®æå‡ä¸ºæ ¸å¿ƒæ•°æ®',time:nowStr()},
];

/* -------------------- ä»ªè¡¨æ¿ -------------------- */
let chartDonut, chartPhase, chartMix;
function syncKpis(){
  document.getElementById('kpi-obj').textContent = objects.length;
  document.getElementById('kpi-threats').textContent = threats.length;
  document.getElementById('kpi-rules').textContent = rules.filter(r=>r.enable).length;
  // åˆ†å¸ƒ
  const counts = { 'ä¸€èˆ¬æ•°æ®':0,'å…¬å¼€æ•°æ®':0,'æ ¸å¿ƒæ•°æ®':0,'é‡è¦æ•°æ®':0 };
  objects.forEach(o=>counts[levelOf(scoreOf(o))]++);
  chartDonut.data.datasets[0].data = [counts['ä¸€èˆ¬æ•°æ®'],counts['å…¬å¼€æ•°æ®'],counts['æ ¸å¿ƒæ•°æ®'],counts['é‡è¦æ•°æ®']];
  chartDonut.update();

  const phaseOrder=['é‡‡é›†','ä¼ è¾“','å…±äº«','å­˜å‚¨','åº”ç”¨'];
  chartPhase.data.labels = phaseOrder;
  chartPhase.data.datasets[0].data = phaseOrder.map(p=>objects.filter(o=>o.phase===p).length||0);
  chartPhase.update();

  const perStage = phaseOrder.map(p=> threats.filter(t=>t.stage===p).length );
  chartMix.data.labels = phaseOrder;
  chartMix.data.datasets[0].data = perStage;
  chartMix.data.datasets[1].data = perStage.map(n=> +(1.5 + n*0.2).toFixed(1));
  chartMix.update();

  // äº‹ä»¶åˆ—è¡¨
  const el=document.getElementById('event-list'); el.innerHTML='';
  events.slice(0,8).forEach(e=>{
    const d=document.createElement('div'); d.className='evt';
    d.innerHTML=`<div class="time">${e.time}</div><b>${e.trigger}</b><p>${e.result}</p>`;
    el.appendChild(d);
  });
}
function initCharts(){
  chartDonut = new Chart(document.getElementById('chart-donut'),{
    type:'doughnut',
    data:{labels:['ä¸€èˆ¬æ•°æ®','å…¬å¼€æ•°æ®','æ ¸å¿ƒæ•°æ®','é‡è¦æ•°æ®'],
      datasets:[{data:[2,1,1,1],borderWidth:0,cutout:'58%',backgroundColor:['#ef4444','#f59e0b','#22c55e','#2563eb']}]},
    options:{plugins:{legend:{display:false}}}
  });
  chartPhase = new Chart(document.getElementById('chart-phase'),{
    type:'bar',
    data:{labels:['é‡‡é›†','ä¼ è¾“','å…±äº«','å­˜å‚¨','åº”ç”¨'],datasets:[{label:'æ•°æ®å¯¹è±¡æ•°é‡',data:[1,1,1,1,1],borderWidth:0,borderRadius:8,backgroundColor:'rgba(99,125,255,.65)'}]},
    options:{plugins:{legend:{display:true,labels:{boxWidth:14}}},scales:{y:{beginAtZero:true,grid:{color:'#eef2ff'}}}}
  });
  chartMix = new Chart(document.getElementById('chart-mix'),{
    data:{labels:['é‡‡é›†','ä¼ è¾“','å…±äº«','å­˜å‚¨','åº”ç”¨'],datasets:[
      {type:'bar',label:'å¨èƒæ•°é‡',data:[3,2,1,2,1],borderWidth:0,borderRadius:6,backgroundColor:'rgba(244,114,182,.45)'},
      {type:'line',label:'å¹³å‡é£é™©ç­‰çº§',data:[2.1,2.3,1.9,2.0,1.8],tension:.35,pointRadius:3,borderWidth:2,borderColor:'#f59e0b',fill:false}
    ]},
    options:{scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'}}}}
  });
  syncKpis();
}
document.getElementById('btn-refresh').onclick=()=>{toast('å·²åˆ·æ–°'); syncKpis();}

/* -------------------- æ•°æ®å¯¹è±¡ç®¡ç† -------------------- */
function renderObjects(){
  const tbl=document.getElementById('obj-table');
  tbl.innerHTML=`
    <thead><tr>
      <th>åç§°</th><th>æ•°æ®ç±»å‹</th><th>ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ</th><th style="width:28%">å®‰å…¨åˆ†å€¼</th>
      <th>å®‰å…¨ç­‰çº§</th><th>æ›´æ–°æ—¶é—´</th><th class="right">æ“ä½œ</th>
    </tr></thead>
    <tbody>
      ${objects.map(o=>{
        const s=scoreOf(o), lv=levelOf(s);
        return `<tr>
          <td>${o.name}</td>
          <td class="muted">${o.type}</td>
          <td><span class="badge ${phaseBadge(o.phase)}">${o.phase}</span></td>
          <td>
            <div class="progress"><div class="bar" style="width:${Math.round(s*100)}%"></div></div>
            <div class="muted">${s.toFixed(2)}</div>
          </td>
          <td><span class="badge ${levelBadge(lv)}">${lv}</span></td>
          <td class="muted">${o.updated}</td>
          <td class="right">
            <button class="btn" onclick="openObj(${o.id})">âœï¸</button>
            <button class="btn danger" onclick="delObj(${o.id})">ğŸ—‘</button>
          </td>
        </tr>`}).join('')}
    </tbody>`;
  syncKpis();
}
function openObj(id){
  const isEdit=!!id; const row=isEdit?objects.find(x=>x.id===id):{name:'',type:'',phase:'é‡‡é›†',attrs:{S:.2,P:.2,C:.2,F:.2,H:.2}};
  showDialog(isEdit?'ç¼–è¾‘æ•°æ®å¯¹è±¡':'æ–°å¢æ•°æ®å¯¹è±¡',[
    ['text','name','åç§°*',row.name,'å¦‚ï¼šå›½å®¶é‡ç‚¹å·¥ç¨‹é¥æ„Ÿå½±åƒæ•°æ®'],
    ['text','type','æ•°æ®ç±»å‹*',row.type,'å¦‚ï¼šé¥æ„Ÿå½±åƒ'],
    ['select','phase','ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ*',row.phase,['é‡‡é›†','ä¼ è¾“','å…±äº«','å­˜å‚¨','åº”ç”¨']],
    ['hr'],
    ['number','S','ç©ºé—´å°ºåº¦(S)',row.attrs.S],['number','P','ä½ç½®ç²¾åº¦(P)',row.attrs.P],
    ['number','C','å†…å®¹æ•æ„Ÿæ€§(C)',row.attrs.C],['number','F','æ•°æ®æµé€šæ€§(F)',row.attrs.F],['number','H','å†å²é£é™©(H)',row.attrs.H],
  ], (vals)=>{
    const attrs={S:+vals.S,P:+vals.P,C:+vals.C,F:+vals.F,H:+vals.H};
    if(isEdit){ Object.assign(row,{name:vals.name,type:vals.type,phase:vals.phase,attrs,updated:nowStr()}); }
    else{ objects.unshift({id:Date.now(),name:vals.name,type:vals.type,phase:vals.phase,attrs,updated:nowStr()}); }
    renderObjects(); toast('å·²ä¿å­˜');
  });
}
function delObj(id){ if(confirm('ç¡®è®¤åˆ é™¤è¯¥å¯¹è±¡ï¼Ÿ')){ objects=objects.filter(x=>x.id!==id); renderObjects(); toast('å·²åˆ é™¤'); } }
document.getElementById('btn-add-obj').onclick=()=>openObj();

/* -------------------- å¨èƒæ¸…å• -------------------- */
function renderThreats(){
  const ph = document.getElementById('threat-filter').value;
  const list = (ph==='å…¨éƒ¨é˜¶æ®µ'?threats:threats.filter(t=>t.stage===ph));
  const wrap=document.getElementById('threat-list'); wrap.innerHTML='';
  list.forEach(t=>{
    const item=document.createElement('div');
    item.style.borderLeft='3px solid #f87171'; item.style.padding='12px 8px'; item.style.marginBottom='8px'; item.style.display='grid';
    item.style.gridTemplateColumns='1fr 120px'; item.style.gap='8px';
    item.innerHTML=`
      <div>
        <div style="display:flex;align-items:center;gap:8px">
          <b>${t.name}</b><span class="badge blue">${t.stage}</span><span class="badge gray mono">${t.id}</span>
        </div>
        <div class="muted">${t.desc}</div>
        <div class="muted">å½±å“èŒƒå›´ï¼š<b>${t.impact}</b></div>
      </div>
      <div class="right">
        <div class="muted">é£é™©ç­‰çº§</div>
        <div style="color:#b91c1c;font-weight:800">${t.risk.toFixed(1)}</div>
        <div style="margin-top:6px">
          <button class="btn" onclick="openThreat('${t.id}')">âœï¸</button>
          <button class="btn danger" onclick="delThreat('${t.id}')">ğŸ—‘</button>
        </div>
      </div>`;
    wrap.appendChild(item);
  });
  syncKpis();
}
document.getElementById('threat-filter').onchange=renderThreats;
function openThreat(id){
  const isEdit=!!id; const row=isEdit?threats.find(x=>x.id===id):{id:'T'+String(Math.random()).slice(2,5),name:'',stage:'é‡‡é›†',desc:'',impact:'',risk:.5};
  showDialog(isEdit?'ç¼–è¾‘å¨èƒ':'æ–°å¢å¨èƒ',[
    ['text','id','ç¼–å·',row.id],['text','name','åç§°*',row.name],['select','stage','é˜¶æ®µ*',row.stage,['é‡‡é›†','ä¼ è¾“','å…±äº«','å­˜å‚¨','åº”ç”¨']],
    ['text','impact','å½±å“ç»´åº¦',row.impact],['number','risk','é£é™©(0~1)',row.risk],['textarea','desc','æè¿°',row.desc]
  ], (v)=>{
    if(isEdit){ Object.assign(row,{name:v.name,stage:v.stage,impact:v.impact,risk:+v.risk,desc:v.desc}); }
    else{ threats.unshift({id:v.id,name:v.name,stage:v.stage,impact:v.impact,risk:+v.risk,desc:v.desc}); }
    renderThreats(); toast('å·²ä¿å­˜');
  });
}
function delThreat(id){ if(confirm('ç¡®è®¤åˆ é™¤è¯¥å¨èƒï¼Ÿ')){ threats = threats.filter(x=>x.id!==id); renderThreats(); toast('å·²åˆ é™¤'); } }
document.getElementById('btn-add-threat').onclick=()=>openThreat();

/* -------------------- æƒé‡é…ç½® -------------------- */
function renderWeights(){
  const host=document.getElementById('weights-form'); host.innerHTML='';
  const fields=[['S','ç©ºé—´å°ºåº¦ (S)'],['P','ä½ç½®ç²¾åº¦ (P)'],['C','å†…å®¹æ•æ„Ÿæ€§ (C)'],['F','æ•°æ®æµé€šæ€§ (F)'],['H','å†å²é£é™© (H)']];
  fields.forEach(([k,label])=>{
    const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr 80px 60px'; row.style.gap='10px'; row.style.alignItems='center'; row.style.margin='14px 0';
    row.innerHTML=`<div><b>${label}</b><div class="muted">${label.replace(/[ï¼ˆ(].*/, '')}å½’ä¸€åŒ–</div></div>
      <input type="range" min="0" max="1" step="0.01" value="${weights[k]}" id="w-${k}">
      <input type="number" min="0" max="1" step="0.01" value="${weights[k]}" id="n-${k}">`;
    host.appendChild(row);
    const rng=row.querySelector(`#w-${k}`), num=row.querySelector(`#n-${k}`);
    const sync=(val)=>{ rng.value=num.value=val; };
    rng.oninput=()=>{ num.value=rng.value; clampTotal(); };
    num.oninput=()=>{ sync(num.value); clampTotal(); };
  });
  const tip=document.createElement('div'); tip.className='muted'; tip.id='w-tip'; host.appendChild(tip);
  updateWeightTip();
}
function totalWeight(){ return +(weights.S+weights.P+weights.C+weights.F+weights.H).toFixed(2); }
function readWeights(){ ['S','P','C','F','H'].forEach(k=>weights[k]=+document.getElementById('w-'+k).value); }
function clampTotal(){
  readWeights();
  const sum=totalWeight();
  // è‡ªåŠ¨æŠŠ H è°ƒæ•´åˆ° 1.0
  const rest = +(1 - (weights.S+weights.P+weights.C+weights.F)).toFixed(2);
  weights.H = Math.max(0, Math.min(1, rest));
  document.getElementById('w-H').value = document.getElementById('n-H').value = weights.H;
  updateWeightTip();
}
function updateWeightTip(){ document.getElementById('w-tip').textContent = `å½“å‰æ€»å’Œï¼š${totalWeight().toFixed(2)}ï¼ˆç›®æ ‡=1.00ï¼‰`; }
document.getElementById('btn-save-weights').onclick=()=>{ clampTotal(); renderObjects(); toast('æƒé‡å·²ä¿å­˜å¹¶é‡æ–°è®¡ç®—åˆ†å€¼'); };

/* -------------------- è§„åˆ™ -------------------- */
function renderRules(){
  const box=document.getElementById('rules-container'); box.innerHTML='';
  rules.forEach(r=>{
    const panel=document.createElement('div'); panel.className='panel'; panel.style.margin='0 0 12px 0';
    panel.innerHTML=`
      <div style="display:flex;align-items:center;gap:10px;padding:16px 16px 0 16px">
        <h3 style="margin:0">${r.id}</h3>
        <span class="badge gray">${r.cat}</span>
        <span class="badge ${r.enable?'green':'red'}">${r.enable?'å¯ç”¨':'åœç”¨'}</span>
        <div class="actions" style="margin-left:auto">
          <button class="btn" onclick="toggleRule('${r.id}')">${r.enable?'ç¦ç”¨':'å¯ç”¨'}</button>
          <button class="btn" onclick="editRule('${r.id}')">âœï¸ ç¼–è¾‘</button>
          <button class="btn danger" onclick="delRule('${r.id}')">ğŸ—‘ åˆ é™¤</button>
        </div>
      </div>
      <div class="pb" style="display:grid;grid-template-columns:1fr 1fr 120px;gap:12px">
        <pre class="mono" style="background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:12px;margin:0">æ¡ä»¶:\n${JSON.stringify(r.cond,null,2)}</pre>
        <pre class="mono" style="background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:12px;margin:0">åŠ¨ä½œ:\n${JSON.stringify(r.act,null,2)}</pre>
        <div class="right">ä¼˜å…ˆçº§<br><b style="font-size:20px">${r.prio}</b></div>
      </div>`;
    box.appendChild(panel);
  });
  syncKpis();
}
function toggleRule(id){ const r=rules.find(x=>x.id===id); r.enable=!r.enable; renderRules(); toast(r.enable?'å·²å¯ç”¨':'å·²åœç”¨'); }
function editRule(id){
  const isEdit=!!id; const r=isEdit?rules.find(x=>x.id===id):{id:'R'+String(Math.random()).slice(2,5),cat:'å±æ€§è§„åˆ™',enable:true,prio:1,cond:{},act:{}};
  showDialog(isEdit?'ç¼–è¾‘è§„åˆ™':'æ–°å¢è§„åˆ™',[
    ['text','id','ID',r.id],['text','cat','ç±»åˆ«',r.cat],['number','prio','ä¼˜å…ˆçº§',r.prio],
    ['textarea','cond','æ¡ä»¶(JSON)',JSON.stringify(r.cond,null,2)],
    ['textarea','act','åŠ¨ä½œ(JSON)',JSON.stringify(r.act,null,2)]
  ], (v)=>{
    try{
      const cond=JSON.parse(v.cond||'{}'), act=JSON.parse(v.act||'{}');
      if(isEdit){ Object.assign(r,{id:v.id,cat:v.cat,prio:+v.prio,cond,act}); }
      else{ rules.unshift({id:v.id,cat:v.cat,enable:true,prio:+v.prio,cond,act}); }
      renderRules(); toast('å·²ä¿å­˜');
    }catch(err){ toast('JSON è§£æå¤±è´¥'); }
  });
}
function delRule(id){ if(confirm('ç¡®è®¤åˆ é™¤è¯¥è§„åˆ™ï¼Ÿ')){ rules = rules.filter(x=>x.id!==id); renderRules(); toast('å·²åˆ é™¤'); } }
document.getElementById('btn-add-rule').onclick=()=>editRule();

/* -------------------- äº‹ä»¶æ—¥å¿— -------------------- */
function renderEvents(){
  const tbl=document.getElementById('events-table');
  tbl.innerHTML=`<thead><tr><th>äº‹ä»¶ID</th><th>è§¦å‘æ¡ä»¶</th><th>æ‰§è¡Œç­–ç•¥</th><th>ç»“æœ</th><th>äº‹ä»¶æ—¶é—´</th></tr></thead>
  <tbody>${events.map(e=>`
    <tr>
      <td class="mono" style="color:#ef4444">${e.id}</td>
      <td>${e.trigger}</td><td>${e.strategy}</td><td><span class="badge green">${e.result}</span></td>
      <td class="muted">${e.time}</td>
    </tr>`).join('')}</tbody>`;
}

/* -------------------- æ‰¹é‡è¯„ä¼° -------------------- */
function runBatch(jsonText){
  try{
    const arr=JSON.parse(jsonText||'[]'); if(!Array.isArray(arr)) throw new Error();
    const res=arr.map(x=>{
      const s=+( (x.spatial_scale||0)*weights.S + (x.position_accuracy||0)*weights.P + (x.content_sensitivity||0)*weights.C + (x.data_flow||0)*weights.F + (x.historical_risk||0)*weights.H ).toFixed(2);
      return {name:x.name||'-',score:s,level:levelOf(s)};
    });
    const tbl=document.getElementById('batch-table');
    tbl.innerHTML=`<thead><tr><th>å¯¹è±¡åç§°</th><th style="width:40%">å®‰å…¨åˆ†å€¼</th><th>å®‰å…¨ç­‰çº§</th></tr></thead>
      <tbody>${res.map(r=>`
        <tr>
          <td>${r.name}</td>
          <td><div class="progress"><div class="bar" style="width:${Math.round(r.score*100)}%"></div></div><div class="muted">${r.score.toFixed(2)}</div></td>
          <td><span class="badge ${levelBadge(r.level)}">${r.level}</span></td>
        </tr>`).join('')}
      </tbody>`;
    toast('è¯„ä¼°å®Œæˆ');
  }catch(e){ toast('JSON æ ¼å¼é”™è¯¯'); }
}
document.getElementById('btn-batch').onclick=()=>runBatch(document.getElementById('batch-input').value);

/* -------------------- é€šç”¨å¼¹çª— -------------------- */
const mask=document.getElementById('mask'), dlgForm=document.getElementById('dlg-form'), dlgTitle=document.getElementById('dlg-title');
let dlgCb=null;
function showDialog(title, schema, onSubmit){
  dlgTitle.textContent=title; dlgForm.innerHTML=''; dlgCb=onSubmit;
  schema.forEach(row=>{
    const [type,key,label,value,extra]=row;
    if(type==='hr'){ const hr=document.createElement('div'); hr.style.gridColumn='1 / -1'; hr.innerHTML='<hr style="border:none;border-top:1px dashed #e5e7eb">'; dlgForm.appendChild(hr); return;}
    const L=document.createElement('label'); L.setAttribute('for',key); L.textContent=label; dlgForm.appendChild(L);
    let input;
    if(type==='textarea'){ input=document.createElement('textarea'); input.id=key; input.value=value||''; }
    else if(type==='select'){ input=document.createElement('select'); input.id=key; (extra||[]).forEach(opt=>{const o=document.createElement('option'); o.value=o.textContent=opt; if(value===opt) o.selected=true; input.appendChild(o)}); }
    else{ input=document.createElement('input'); input.id=key; input.type=type; input.value=value??''; if(type==='number'){ input.step='0.01'; input.min='0'; input.max='1'; } }
    dlgForm.appendChild(input);
  });
  mask.style.display='flex';
}
function closeDialog(){ mask.style.display='none'; dlgCb=null; }
document.getElementById('dlg-cancel').onclick=closeDialog;
document.getElementById('mask').addEventListener('click',e=>{ if(e.target.id==='mask') closeDialog(); });
document.getElementById('dlg-form').addEventListener('submit',e=>{
  e.preventDefault(); if(!dlgCb) return;
  const vals={}; [...dlgForm.elements].forEach(el=>{ if(el.id) vals[el.id]=el.value; });
  closeDialog(); dlgCb(vals);
});

/* -------------------- åˆå§‹åŒ–æ¸²æŸ“ -------------------- */
function boot(){
  renderObjects(); renderThreats(); renderWeights(); renderRules(); renderEvents(); runBatch(document.getElementById('batch-input').value);
  if(!window._chartsInited){ initCharts(); window._chartsInited=true; }
}
window.addEventListener('load', boot);
</script>
</body>
</html>
